<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coverage Validation Tool</title>
<style>
  body { font-family: Arial, sans-serif; background: #f9fafb; margin: 0; padding: 2rem; }
  h1 { color: #333; }
  .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; max-width: 800px; margin: auto; }
  label { display: block; font-weight: bold; margin-top: 1rem; }
  textarea, input[type="number"] { width: 100%; padding: 8px; margin-top: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
  button { margin-top: 1.5rem; padding: 10px 16px; border: none; border-radius: 6px; background: #2563eb; color: white; font-size: 16px; cursor: pointer; }
  button:hover { background: #1d4ed8; }
  pre { background: #f1f5f9; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 1rem; }
</style>
</head>
<body>
  <div class="card">
    <h1>Coverage Validation</h1>
    <label><input type="checkbox" id="hasCover"> Has Existing Cover</label>

    <label>Previous Codes:</label>
    <textarea id="prevCodes" rows="5" placeholder="Enter previous codes, separated by commas or newlines"></textarea>

    <label>Current Codes:</label>
    <textarea id="currCodes" rows="5" placeholder="Enter current codes, separated by commas or newlines"></textarea>

    <label>Days Apart:</label>
    <input type="number" id="daysApart" placeholder="e.g. 500">

    <button onclick="validate()">Validate</button>

    <pre id="output"></pre>
  </div>

<script>
function parseCodes(input) {
  return input.split(/[\n,]+/).map(c => c.trim()).filter(Boolean).map(code => {
    const parts = code.split("-");
    return {
      full: code,
      type: parts[0] || "",
      family: parts[3] || "",
      amount: parseFloat(parts[5]) || 0,
      nature: parts[7] || ""
    };
  });
}

function sumLoad(codes, typePrefix="LD") {
  return codes.filter(c => c.type.startsWith(typePrefix)).reduce((sum, c) => sum + c.amount, 0);
}

function countType(codes, type="EMC") {
  return codes.filter(c => c.type.startsWith(type)).length;
}

function getMissingCodes(prev, curr, matchType) {
  const prevSet = prev.filter(c => c.type.startsWith(matchType));
  const currSet = curr.filter(c => c.type.startsWith(matchType));
  return prevSet.filter(pc => !currSet.some(cc => cc.family === pc.family));
}

function getReducedLoadCodes(prev, curr) {
  const missing = [];
  for (const pc of prev.filter(c => c.type.startsWith("LD"))) {
    const match = curr.find(cc => cc.family === pc.family && cc.type.startsWith("LD"));
    if (!match || match.amount < pc.amount) missing.push(pc);
  }
  return missing;
}

function validate() {
  const hasCover = document.getElementById("hasCover").checked;
  const prev = parseCodes(document.getElementById("prevCodes").value);
  const curr = parseCodes(document.getElementById("currCodes").value);
  const daysApart = parseInt(document.getElementById("daysApart").value || "0");

  if (!hasCover) {
    document.getElementById("output").textContent = JSON.stringify({ result: "Accepted" }, null, 2);
    return;
  }

  const nature = (curr[0]?.nature || "").toUpperCase(); // assume current nature as reference
  const totalPrevLoad = sumLoad(prev, "LD");
  const totalCurrLoad = sumLoad(curr, "LD");
  const loadDiff = totalPrevLoad - totalCurrLoad;
  const emcDiff = countType(prev, "EMC") - countType(curr, "EMC");
  const ld1Missing = getMissingCodes(prev, curr, "LD1");
  const emcMissing = getMissingCodes(prev, curr, "EMC");
  const loadMissing = getReducedLoadCodes(prev, curr);

  let result = "Accepted";

  // === Apply Rules ===
  if (["AUDT","OCCU"].includes(nature) && loadDiff > 50 && daysApart <= 1095) result = "Decline";
  else if (nature === "AUDT" && emcDiff > 1 && daysApart <= 1825) result = "Decline";
  else if (["AUDT","OCCU"].includes(nature) && ld1Missing.length > 0 && daysApart <= 1825) result = "Decline";
  else if (["AUDT","OCCU"].includes(nature) && ld1Missing.length > 0 && daysApart > 1825) result = "ModifiedDeclaration";
  else if (["AUDT","OCCU"].includes(nature) && loadDiff > 50 && daysApart > 1095) result = "ModifiedDeclaration";
  else if (nature === "AUDT" && emcDiff > 1 && daysApart > 1825) result = "ModifiedDeclaration";
  else if (nature === "AUDT" && emcDiff === 1) result = "ModifiedDeclaration";
  else if (["AUDT","OCCU"].includes(nature) && loadDiff >= 0 && loadDiff <= 50) result = "ModifiedDeclaration";
  else if (["AUDT","OCCU"].includes(nature) && loadMissing.length > 0) result = "ModifiedDeclaration";

  const codes = {
    LOAD: loadMissing.map(c => c.full),
    EMC: emcMissing.map(c => c.full),
    LOAD1: ld1Missing.map(c => c.full)
  };

  document.getElementById("output").textContent = JSON.stringify({ result, codes }, null, 2);
}
</script>
</body>
</html>
